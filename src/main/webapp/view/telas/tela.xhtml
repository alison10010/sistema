<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:p="http://primefaces.org/ui"
                template="/view/layout/layout.xhtml">

    <ui:define name="title">Tela de Chamadas</ui:define>

    <ui:define name="content">

        <link rel="stylesheet" href="/sistema/css/tela.css" />
        
        <style>
        
        	/* ===== Layout Video (igual ao desenho) ===== */
			.main-layout-video{
			  display: grid;
			  grid-template-columns: 2.2fr 1fr; /* esquerda maior, direita menor */
			  height: calc(100vh - 70px);       /* ajuste conforme sua header */
			  gap: 0;
			  border-top: 2px solid #111;
			}
			
			.video-panel{
			  border-right: 4px solid #111; /* linha grossa central */
			  display: flex;
			  align-items: center;
			  justify-content: center;
			  padding: 0;
			  background: #fff;
			}
			
			.video-frame{
			  width: 100%;
			  height: 100%;
			}
			
			.video-frame iframe{
			  width: 100%;
			  height: 100%;
			  border: 0;
			}
			
			.right-panel{
			  display: grid;
			  grid-template-rows: 1fr 1fr; /* topo e baixo */
			  height: 100%;
			  background: #fff;
			}
			
			.current-call-video{
			  border-bottom: 4px solid #111;
			  display: flex;
			  flex-direction: column;
			  align-items: center;
			  justify-content: center;
			  padding: 18px;
			  text-align: center;
			}
			
			.current-call-video .label{
			  font-size: 1.4rem;
			  opacity: .85;
			  margin-bottom: 12px;
			}
			
			.current-call-video .big-ticket{
			  font-size: 4.2rem;
			  font-weight: 900;
			  line-height: 1;
			  margin-bottom: 14px;
			}
			
			.current-call-video .room-value{
			  font-size: 3.2rem;
			  font-weight: 900;
			  line-height: 1.1;
			}
			
			.previous-calls-video{
			  padding: 18px 22px;
			  overflow: hidden;
			  display: flex;
			  flex-direction: column;
			}
			
			.previous-calls-video #filaHistorico{
			  overflow: auto;        /* rola se tiver muitas */
			  padding-right: 6px;
			}
			
			.previous-item-video{
			  display: flex;
			  justify-content: space-between;
			  align-items: baseline;
			  padding: 10px 0;
			  border-bottom: 1px solid rgba(0,0,0,.08);
			  font-weight: 900;
			}
			
			.previous-item-video .ticket{
			  font-size: 2.2rem;
			  letter-spacing: .02em;
			}
			
			.previous-item-video .guiche{
			  font-size: 2.2rem;
			}
			
			/* Responsivo: em telas menores vira coluna */
			@media (max-width: 992px){
			  .main-layout-video{
			    grid-template-columns: 1fr;
			    grid-template-rows: 1.2fr 1fr;
			  }
			  .video-panel{
			    border-right: 0;
			    border-bottom: 4px solid #111;
			  }
			  .right-panel{
			    grid-template-rows: auto 1fr;
			  }
			}
			        	
        </style>
        
        
        <!-- TOPO -->
		<div class="header-bar">
		    <div class="header-title">
		         
		    </div>
		    <div id="relogio" class="fs-4 text-secondary"></div>
		</div>
		
		<!-- LAYOUT (muda conforme painelController.layout) -->
		<c:choose>
		
		    <!-- ===================== LAYOUT VIDEO ===================== -->
		    <c:when test="#{painelController.layout eq 'video'}">
		
		        <div class="main-layout-video">
		
		            <!-- ESQUERDA: VÍDEO -->
		            <div class="video-panel">
		                <div class="video-frame">
		                    <!-- Troque o VIDEO_ID -->
		                    <iframe
							    src="https://www.youtube-nocookie.com/embed/VayOrXlERHs?autoplay=1&amp;mute=0&amp;controls=0&amp;rel=0&amp;modestbranding=1&amp;loop=1&amp;playlist=VayOrXlERHs"
							    allow="autoplay; encrypted-media; picture-in-picture"
							    allowfullscreen="allowfullscreen">
							</iframe>

		                </div>
		            </div>
		
		            <!-- DIREITA: ÚLTIMA SENHA (TOPO) + HISTÓRICO (BAIXO) -->
		            <div class="right-panel">
		
		                <!-- TOPO: ÚLTIMA SENHA -->
		                <div class="current-call-video">
		                    <div class="label">Última senha</div>
		
		                    <div class="big-ticket" id="senhaFormatadaAtual">---</div>
		
		                    <div class="room-value">
		                        <span id="guicheAtual">--</span>
		                    </div>
		
		                    <div class="patient-name" id="pacienteAtual"></div>
		                    <div class="patient-name" id="descricaoAtual" style="opacity:.85; font-size: 1.2rem;"></div>
		                </div>
		
		                <!-- BAIXO: HISTÓRICO -->
		                <div class="previous-calls-video">
		
		                    <h:form id="formTela">
		
		                        <p:remoteCommand name="rcAtualizaNotif"
		                                         process="@this"
		                                         update=":formTela:filaHistorico" />
		
		                        <h:panelGroup id="filaHistorico">
		                            <ui:repeat value="#{painelController.senhasAnteriores()}" var="senhaFila">
		
		                                <div class="previous-item-video">
		                                    <div class="left">
		                                        <div class="ticket">#{senhaFila.senhaVisual}</div>
		                                    </div>
		
		                                    <div class="right">
		                                        <div class="guiche">#{senhaFila.comparecer} #{senhaFila.guiche}</div>
		                                    </div>
		                                </div>
		
		                            </ui:repeat>
		                        </h:panelGroup>
		
		                    </h:form>
		
		                </div>
		            </div>
		
		        </div>
		
		    </c:when>
		
		    <!-- ===================== LAYOUT NORMAL (SEU ATUAL) ===================== -->
		    <c:otherwise>
		
		        <!-- LAYOUT PRINCIPAL (SEU ATUAL - NÃO MUDEI NADA) -->
		        <div class="main-layout">
		
		            <!-- CHAMADA ATUAL -->
		            <div class="current-call">
		
		                <div class="label">Chamada Atual</div>
		
		                <div class="big-ticket" id="senhaFormatadaAtual">---</div>
		
		                <div class="patient-title">Tipo:</div>
		                <div class="patient-name" id="descricaoAtual">---</div>
		
		                <div class="room-title">Comparecer:</div>
		                <div class="room-value">
		                    <span id="guicheAtual">--</span>
		                </div>
		
		                <br />
		                <div class="patient-name" id="pacienteAtual"></div>
		            </div>
		
		            <!-- HISTÓRICO -->
		            <div class="previous-calls">
		                <div class="previous-title">Chamados Recentes</div>
		
		                <h:form id="formTela">
		                    <p:remoteCommand name="rcAtualizaNotif"
		                                     process="@this"
		                                     update=":formTela:filaHistorico" />
		
		                    <h:panelGroup id="filaHistorico">
		                        <ui:repeat value="#{painelController.senhasAnteriores()}" var="senhaFila">
		
		                            <div class="previous-item">
		                                <strong>
		                                    <span>#{senhaFila.senhaVisual}</span>
		                                </strong>
		
		                                <div style="display: flex;justify-content: space-between;">
		                                    <div class="previous-meta">#{senhaFila.comparecer} #{senhaFila.guiche}</div>
		                                    <span class="badge #{senhaFila.tipo == 'P' ? 'bg-danger' : 'bg-primary'} rounded-pill">
		                                        #{senhaFila.tipo == 'P' ? 'Prioridade' : 'Normal'}
		                                    </span>
		                                </div>
		                            </div>
		
		                        </ui:repeat>
		                    </h:panelGroup>
		                </h:form>
		            </div>
		
		        </div>
		
		    </c:otherwise>
		</c:choose>     


        <!-- JS de WebSocket (ajuste os paths conforme seus webjars / estáticos) -->
        <script src="/sistema/bootstrap/sockjs.min.js"></script>
        <script src="/sistema/bootstrap/stomp.min.js"></script>

        <script type="text/javascript">
		    let stompClientTela = null;
		
		    function conectarTelaPainel() {
		        const socket = new SockJS('/sistema/ws');
		        stompClientTela = Stomp.over(socket);
		        stompClientTela.debug = null; // desliga logs
		
		        stompClientTela.connect({}, function (frame) {
		            console.log('Conectado ao WebSocket da Tela:', frame);
		
		            // topic que o backend usa em enviarParaTela(...)
		            stompClientTela.subscribe('/topic/senha', function (mensagem) {
		                const data = JSON.parse(mensagem.body);
		                atualizarTelaComSenha(data);
		            });

		            stompClientTela.subscribe('/topic/updateHistorico', function (mensagem) {
		                console.log('Mensagem em /topic/updateHistorico:', mensagem.body);
		                if (typeof rcAtualizaNotif === 'function') {
		                    rcAtualizaNotif();
		                } else {
		                    console.error('rcAtualizaNotif não está definido!');
		                }
		            });
		            
		        }, function (erro) {
		            console.error('Erro na conexão WebSocket da Tela:', erro);
		            setTimeout(conectarTelaPainel, 5000);
		        });

		        
		    }
		
		    function atualizarTelaComSenha(data) {

		        console.log("Dados recebidos da senha:", data);

		        // Usa senhaFormatada, ou monta com tipo+senha
		        const senhaFormatada = data.senhaFormatada
		            || ((data.tipo || '') + ' ' + (data.senha != null ? String(data.senha) : ''));

		        const descricao   = data.descricao || '';
		        const guicheTexto = data.guiche != null ? (data.guiche) : '--';
		        const paciente    = data.paciente || '';

		        // Atualiza painel grande
		        document.getElementById('senhaFormatadaAtual').textContent = senhaFormatada;
		        document.getElementById('descricaoAtual').textContent      = descricao;
		        document.getElementById('guicheAtual').textContent         = guicheTexto;
		        document.getElementById('pacienteAtual').textContent       = paciente;

		        // Salva o estado no localStorage
		        const estadoSenha = {
		            senhaFormatadaAtual: senhaFormatada,
		            descricaoAtual: descricao,
		            guicheAtual: guicheTexto,
		            pacienteAtual: paciente
		        };

		        try {
		            localStorage.setItem('painel_senha_atual', JSON.stringify(estadoSenha));
		        } catch (e) {
		            console.error("Erro ao salvar dados no localStorage:", e);
		        }
		    }

		
		    window.addEventListener('load', function () {
		        restaurarSenhaAtual();
		        conectarTelaPainel();

		        atualizarRelogio();
		        setInterval(atualizarRelogio, 1000);

		        document.addEventListener("click", function () {
		            if (!document.fullscreenElement) {
		                document.documentElement.requestFullscreen();
		            }
		        });
		    });


		 	// Relógio 
		    function atualizarRelogio() {
		        const r = document.getElementById("relogio");
		        const agora = new Date();
		        r.textContent = agora.toLocaleTimeString("pt-BR", {
		            hour: "2-digit",
		            minute: "2-digit",
		            second: "2-digit"
		        });
		    }

		    function restaurarSenhaAtual() {
		        const json = localStorage.getItem('painel_senha_atual');
		        if (!json) {
		            return;
		        }

		        try {
		            const estado = JSON.parse(json);

		            if (estado.senhaFormatadaAtual) {
		                document.getElementById('senhaFormatadaAtual').textContent = estado.senhaFormatadaAtual;
		            }
		            if (estado.descricaoAtual) {
		                // aqui era tipoAtual, mas o id no HTML é descricaoAtual
		                document.getElementById('descricaoAtual').textContent = estado.descricaoAtual;
		            }
		            if (estado.guicheAtual) {
		                document.getElementById('guicheAtual').textContent = estado.guicheAtual;
		            }
		            if (estado.pacienteAtual) {
		                document.getElementById('pacienteAtual').textContent = estado.pacienteAtual;
		            }
		        } catch (e) {
		            console.error('Erro ao restaurar senha do localStorage', e);
		        }
		    }

		</script>


    </ui:define>
</ui:composition>
