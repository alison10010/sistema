<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:p="http://primefaces.org/ui"
                template="/view/layout/layout.xhtml">

    <ui:define name="title">Painel</ui:define>

    <ui:define name="content">

        <!-- =============================== -->
        <!--   ESTILOS DO PAINEL NOVO       -->
        <!-- =============================== -->
        <style>
        
        	@media (min-width: 1400px) {
			    .container, .container-lg, .container-md, .container-sm, .container-xl, .container-xxl {
			        max-width: 95% !important;
			    }
			}
            :root {
                --primary: #2563EB;
                --primary-soft: rgba(37, 99, 235, 0.15);
                --bg-soft: #f4f6fb;
                --card-radius: 1.2rem;
            }

            body {
                background: radial-gradient(circle at top left, #e3f2fd 0, #f4f6fb 45%, #eef1f7 100%);
            }

            .totem-container {
                min-height: calc(100vh - 80px);
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .totem-shell {
                background: #fff;
                border-radius: 1.6rem;
                padding: 2.2rem;
                border: 1px solid #e2e8f0;
                box-shadow: 0 18px 45px rgba(15, 23, 42, 0.16);
            }

            /* Cabeçalho */
            .totem-header {
                border-bottom: 1px dashed rgba(148, 163, 184, 0.5);
                padding-bottom: 1.25rem;
                margin-bottom: 1.5rem;
            }

            .totem-title {
                font-size: 2rem;
                font-weight: 700;
                color: #1e293b;
            }

            .totem-subtitle {
                font-size: .95rem;
                color: #64748b;
            }

            .step-title {
                text-transform: uppercase;
                font-size: .75rem;
                color: #94a3b8;
                font-weight: 700;
                letter-spacing: .12rem;
            }

            /* Cards dos serviços */
            .card-main {
                border-radius: var(--card-radius);
                background: #fff;
                border: 2px solid transparent;
                cursor: pointer;
                padding: .8rem 1rem;
                transition: .15s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            }

            .card-main:hover {
                border-color: var(--primary);
                box-shadow: 0 12px 25px rgba(37, 99, 235, .25);
            }

            .card-main.active {
                border-color: var(--primary);
                background: rgba(37, 99, 235, 0.06);
                box-shadow: 0 12px 25px rgba(37, 99, 235, .35);
            }

            .card-main-badge {
                min-width: 3rem;
                height: 3rem;
                background: var(--primary-soft);
                color: var(--primary);
                border-radius: 999px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 1.25rem;
                font-weight: 700;
            }

            /* Painel da última senha */
            .painel-senha-atual {
                border-radius: 1.6rem;
                background: linear-gradient(to bottom right, #e0f2fe, #eef2ff);
                padding: 2rem;
                text-align: center;
                box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            }

            .painel-senha-atual .label {
                text-transform: uppercase;
                font-size: .75rem;
                letter-spacing: .12rem;
                color: #64748b;
                font-weight: 700;
            }

            .painel-senha-atual .numero {
                font-size: 4.5rem;
                font-weight: 800;
                color: #0f172a;
            }

            .painel-senha-atual .guiche {
                font-size: 1.5rem;
                font-weight: 600;
                color: #2563EB;
            }

            /* Botões */
            .big-btn {
                width: 100%;
                padding: 1rem;
                font-size: 1.1rem;
                font-weight: 600;
                border-radius: .9rem;
            }

            /* Fila de espera lateral */
            .fila-item {
                display: flex;
                justify-content: space-between;
                padding: .8rem .5rem;
                border-bottom: 1px solid #e2e8f0;
            }

            .fila-senha {
                font-size: 1.15rem;
                font-weight: 700;
            }

            .fila-paciente {
                font-size: .85rem;
                color: #64748b;
            }

        </style>

        <!-- =============================== -->
        <!--           FORMULARIO            -->
        <!-- =============================== -->

        <h:form id="formPainel">

            <p:growl id="msgs" showDetail="true" life="3000"/>

            <div class="container-fluid totem-container">
                <div class="container">
                    <div class="totem-shell">

                        <!-- Cabeçalho -->
                        <div class="totem-header d-flex flex-wrap justify-content-between align-items-center">
                            <div>
                                <div class="totem-title">Painel de Chamadas</div>
                                <div class="totem-subtitle">
                                    Selecione o serviço e utilize os botões <strong>Chamar</strong> e <strong>Rechamar</strong>.
                                </div>
                            </div>

                            <div class="text-end">
                                <span class="step-title">Guichê Atual</span>
                                <div class="d-flex align-items-center gap-2 mt-1">
                                    <h:selectOneMenu value="#{painelController.guicheSelecionado}"
                                                     id="guiche"
                                                     styleClass="form-select form-select-sm"
                                                     style="width: 120px;">
                                        <f:selectItem itemValue="" itemLabel="Selecione..." noSelectionOption="true"/>
                                        <f:selectItem itemValue="1" itemLabel="Guichê 1"/>
                                        <f:selectItem itemValue="2" itemLabel="Guichê 2"/>
                                        <f:selectItem itemValue="3" itemLabel="Guichê 3"/>
                                        <f:selectItem itemValue="4" itemLabel="Guichê 4"/>
                                        <f:selectItem itemValue="5" itemLabel="Guichê 5"/>
                                    </h:selectOneMenu>

                                </div>
                            </div>
                        </div>


                        <!-- ====================================== -->
                        <!--           3 COLUNAS IGUAL FOTO         -->
                        <!-- ====================================== -->

                        <div class="row g-4 mt-1 align-items-stretch">

                            <!-- ====================================== -->
                            <!--          COLUNA 1 – SERVIÇOS           -->
                            <!-- ====================================== -->
                            <div class="col-lg-4 border-end border-gray-200">

                                <div class="row g-3">
                                    <ui:repeat value="#{painelController.servicos}" var="s">
                                        <div class="col-12">
                                            <p:commandLink actionListener="#{painelController.selecionarServico(s)}"
                                                           update="@form"
                                                           process="@this"
                                                           style="text-decoration:none;">

                                                <div class="card-main #{painelController.servicoSelecionado != null and painelController.servicoSelecionado.id == s.id ? 'active' : ''}">
                                                    <div class="d-flex align-items-center gap-3">
                                                        <div class="card-main-badge">
                                                            #{s.prefixo}
                                                        </div>
                                                        <div>
                                                            <div class="card-main-title fs-6 fw-bold">
                                                                #{s.nome}
                                                            </div>
                                                            <div class="card-main-desc">
                                                                Clique para ver a fila deste serviço.
                                                            </div>
                                                        </div>
                                                        <div class="ms-auto d-none d-md-block">
                                                            <i class="bi bi-chevron-right text-muted"></i>
                                                        </div>
                                                    </div>
                                                </div>

                                            </p:commandLink>
                                        </div>
                                    </ui:repeat>
                                </div>
                            </div>


                            <!-- ====================================== -->
                            <!--   COLUNA 2 – SENHA ATUAL + BOTÕES      -->
                            <!-- ====================================== -->
                            <div class="col-lg-5">

                                <!-- Painel da última senha -->
                                <h:panelGroup id="painelInfo">
                                    <div class="painel-senha-atual mb-3">
                                        <div class="label mb-2">Última senha chamada</div>

                                        <div class="numero">
                                            <h:outputText value="#{painelController.ultimaSenha}" />
                                        </div>

                                        <div class="guiche mt-2">
                                           <h:outputText value="#{painelController.ultimoGuiche != null ? painelController.ultimoGuiche : painelController.guicheSelecionado}" />
                                        </div>

                                        <div class="mt-2">
                                            Tipo:
                                            <strong><h:outputText value="#{painelController.ultimoTipoFicha}" /></strong>
                                        </div>
                                    </div>
                                </h:panelGroup>

                                <!-- Botões -->
                                <div class="row g-2 mb-4">
                                    <div class="col-md-6">
                                        <p:commandButton value="Chamar"
                                                         icon="bi bi-play-fill"
                                                         styleClass="btn btn-success big-btn"
                                                         actionListener="#{painelController.chamarProximaSenha}"
                                                         update="formPainel:painelInfo formPainel:filaEspera formPainel:msgs"
                                                         process="@form"/>
                                    </div>

                                    <div class="col-md-6">
                                        <p:commandButton value="Rechamar"
                                                         icon="bi bi-volume-up-fill"
                                                         styleClass="btn btn-outline-warning big-btn"
                                                         actionListener="#{painelController.rechamarUltimaSenha}"
                                                         update="formPainel:painelInfo formPainel:msgs"
                                                         process="@form"/>
                                    </div>
                                </div>

                            </div>


                            <!-- ====================================== -->
                            <!--      COLUNA 3 – FILA DE ESPERA         -->
                            <!-- ====================================== -->
                            <div class="col-lg-3">
                                <h:panelGroup id="filaEspera">

                                    <div class="card shadow-sm border-0 h-100" style="border-radius: 1.1rem;">
                                        <div class="card-body d-flex flex-column">

                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h5 class="mb-0">Fila de espera (#{painelController.senhasAguardandoPorServico.size()})</h5>
                                                <small class="text-muted">
                                                    <h:outputText value="#{painelController.servicoSelecionado != null ? painelController.servicoSelecionado.nome : 'Nenhum serviço'}"/>
                                                </small>
                                            </div>

                                            <ui:fragment rendered="#{empty painelController.senhasAguardandoPorServico}">
                                                <div class="text-muted" style="font-size: 0.9rem;">
                                                    Nenhuma senha aguardando.
                                                </div>
                                            </ui:fragment>

                                            <ui:fragment rendered="#{not empty painelController.senhasAguardandoPorServico}">
                                                <div style="max-height: 380px; overflow-y: auto; margin-top: .5rem;">
                                                    <ui:repeat value="#{painelController.senhasAguardandoPorServico}" var="s">

                                                        <div class="fila-item">
                                                            <div>
                                                                <div class="fila-senha">#{s.senhaVisual}</div>
                                                                <div class="fila-paciente">
                                                                    <h:outputText value="#{s.paciente}" />
                                                                </div>
                                                            </div>
                                                            <small class="text-muted">
                                                                <h:outputText value="#{s.subServico != null ? s.subServico.nome : ''}" />
                                                            </small>
                                                        </div>

                                                    </ui:repeat>
                                                </div>
                                            </ui:fragment>
                                            
                                            <p:remoteCommand name="rcAtualizaNotif"
			                                 process="@this"
			                                 update=":formPainel:filaEspera" />

                                        </div>
                                    </div>

                                </h:panelGroup>
                            </div>

                        </div>


                    </div>
                </div>
            </div>

        </h:form>
        
        <!-- JS de WebSocket (ajuste os paths conforme seus webjars / estáticos) -->
        <script src="/sistema/bootstrap/sockjs.min.js"></script>
        <script src="/sistema/bootstrap/stomp.min.js"></script>
        
        <script type="text/javascript">
      		//<![CDATA[
			    var socketUpdate = new SockJS('/sistema/ws');
			    var stompUpdate = Stomp.over(socketUpdate);
			
			    stompUpdate.debug = null; // opcional (remove logs)
			
			    stompUpdate.connect({}, function () {
			
			        console.log("Conectado ao WS!");
			
			        // Chama o AJAX para atualizar a lista de senhas
			        stompUpdate.subscribe('/topic/listEsperaPainel', function (message) {
			        	rcAtualizaNotif();
			        });
			
			        //  Mostra alerta quando gerar senha
			        stompUpdate.subscribe('/topic/senhaGeradaInfo', function (message) {
			        	rcAtualizaNotif();
			        });
			
			    }, function(error){
			        console.error("Erro no WebSocket:", error);
			    });
		    //]]>
		</script>
        


    </ui:define>
</ui:composition>
